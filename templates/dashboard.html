{% extends "base.html" %}

{% block title %}Dashboard - LinkShort{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- User Info Card -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h3>Welcome back, {{ user.email }}</h3>
                            <p class="mb-0">
                                {% if user.is_premium %}
                                    <span class="badge bg-success"><i class="bi bi-star-fill"></i> Premium Member</span>
                                    <span class="text-muted">Unlimited links and advanced analytics</span>
                                {% else %}
                                    <span class="badge bg-secondary">Free Plan</span>
                                    <span class="text-muted">{{ user.monthly_quota - user.used_quota }} of {{ user.monthly_quota }} links remaining</span>
                                    <a href="{{ url_for('pricing') }}" class="ms-2">Upgrade to Premium</a>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newLinkModal">
                                <i class="bi bi-plus-circle"></i> New Link
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Google AdSense Placeholder -->
    {% if not user.is_premium %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body text-center py-4">
                    <small class="text-muted">Advertisement</small>
                    <div style="background: #f8f9fa; border: 2px dashed #dee2e6; padding: 30px;">
                        [Google AdSense Banner - 728x90]
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Stats Overview -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card stats-card">
                <div class="card-body">
                    <h6 class="text-muted">Total Links</h6>
                    <h3 class="mb-0">{{ urls|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stats-card">
                <div class="card-body">
                    <h6 class="text-muted">Total Clicks</h6>
                    <h3 class="mb-0">{{ urls|sum(attribute='total_clicks') }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stats-card">
                <div class="card-body">
                    <h6 class="text-muted">Unique Visitors</h6>
                    <h3 class="mb-0">{{ urls|sum(attribute='unique_clicks') }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stats-card">
                <div class="card-body">
                    <h6 class="text-muted">Avg. CTR</h6>
                    <h3 class="mb-0">
                        {% if urls|length > 0 %}
                            {{ "%.1f"|format((urls|sum(attribute='total_clicks') / urls|length) if urls|length else 0) }}
                        {% else %}
                            0
                        {% endif %}
                    </h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Links Table -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Your Links</h5>
                </div>
                <div class="card-body">
                    {% if urls %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Short URL</th>
                                    <th>Original URL</th>
                                    <th>Clicks</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for url in urls %}
                                <tr>
                                    <td>
                                        <div class="input-group input-group-sm">
                                            <input type="text" 
                                                   class="form-control" 
                                                   value="{{ request.url_root }}{{ url.short_code }}" 
                                                   id="short-{{ url.id }}" 
                                                   readonly>
                                            <button class="btn btn-outline-secondary" 
                                                    onclick="copyToClipboard('short-{{ url.id }}')">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </td>
                                    <td>
                                        <a href="{{ url.original_url }}" target="_blank" class="text-truncate d-inline-block" style="max-width: 300px;">
                                            {{ url.original_url }}
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ url.total_clicks }}</span> / 
                                        <span class="badge bg-secondary">{{ url.unique_clicks }}</span>
                                    </td>
                                    <td>{{ url.created_at.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="showAnalytics('{{url.id}}', '{{ url.short_code }}')">
                                            <i class="bi bi-graph-up"></i>
                                        </button>
                                        <form action="{{ url_for('delete_url', url_id=url.id) }}" method="POST" class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                    onclick="return confirm('Are you sure you want to delete this link?')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-link-45deg text-muted" style="font-size: 4rem;"></i>
                        <h5 class="mt-3">No links yet</h5>
                        <p class="text-muted">Create your first shortened link to get started</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Google AdSense Placeholder -->
    {% if not user.is_premium %}
    <div class="row">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body text-center py-3">
                    <small class="text-muted">Advertisement</small>
                    <div style="background: #f8f9fa; border: 2px dashed #dee2e6; padding: 20px;">
                        [Google AdSense Banner - 728x90]
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- New Link Modal -->
<div class="modal fade" id="newLinkModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Short Link</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('shorten_url') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="url" class="form-label">Enter URL to shorten</label>
                        <input type="url" class="form-control" name="url" required placeholder="https://example.com">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Link</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Analytics Modal -->
<div class="modal fade" id="analyticsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Link Analytics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <canvas id="clicksChart"></canvas>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="text-center">
                            <h4 id="totalClicksDisplay">-</h4>
                            <p class="text-muted">Total Clicks</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-center">
                            <h4 id="uniqueClicksDisplay">-</h4>
                            <p class="text-muted">Unique Visitors</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentChart = null;

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    document.execCommand('copy');
    
    // Show feedback
    const btn = element.nextElementSibling;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check"></i>';
    setTimeout(() => {
        btn.innerHTML = originalHTML;
    }, 2000);
}

function showAnalytics(urlId, shortCode) {
    fetch(`/api/analytics/${urlId}`)
        .then(response => response.json())
        .then(data => {
            // Update displays
            document.getElementById('totalClicksDisplay').textContent = data.total_clicks;
            document.getElementById('uniqueClicksDisplay').textContent = data.unique_clicks;
            
            // Destroy existing chart if it exists
            if (currentChart) {
                currentChart.destroy();
            }
            
            // Create new chart
            const ctx = document.getElementById('clicksChart').getContext('2d');
            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.dates,
                    datasets: [{
                        label: 'Clicks',
                        data: data.counts,
                        borderColor: '#007BFF',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Clicks over the last 7 days'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
            
            // Show modal
            new bootstrap.Modal(document.getElementById('analyticsModal')).show();
        });
}
</script>
</body>
{% endblock %}